# e2etest-ipam - Persistent IPAM for dual-stack VPC provisioning
# ==============================================================
# Creates IPAM with IPv4 + IPv6 pools for VPC/subnet allocation.
# Resources are orphaned via managementPolicies (no Delete) for reuse.
#
# After first run, update externalName fields with actual IDs to import.
# These same resources are used by aws-foundation e2e test.
#
# Pools created (persistent):
# - ipv4: 10.0.0.0/8 for VPC IPv4 CIDRs
# - ipv6-public: Amazon-provided GUA for internet-routable workloads
# Note: ULA (fd00::/8) CIDRs are NOT supported by AWS IPAM - only Amazon-provided GUA or BYOIP
#
# Pools created (ephemeral - deleted after test):
# - aws-ipam-<timestamp>: test pool to verify create/delete cycle

import base64
import datetime
import file
import math
import models.ai.com.ops.hops.aws.v1alpha1 as hops
import models.io.upbound.dev.meta.v1alpha1 as metav1alpha1

_now = str(int(math.floor(datetime.ticks())))

_creds = file.read("secrets/aws-creds")
_base64_creds = base64.encode(_creds)

# =============================================================================
# Configuration - shared with aws-foundation e2e test
# =============================================================================

_org_name = "hops"
_composite_name = "hops-e2e-ipam"
_home_region = "us-east-2"

# Orphan management policies - no Delete means resources persist
_persist = ["Create", "Observe", "Update", "LateInitialize"]

# Ephemeral test pool name - deleted after test
_test_pool_name = "aws-ipam-" + _now

# =============================================================================
# Existing resource IDs (update after first successful run)
# =============================================================================
# After running once, get IDs with:
#   aws ec2 describe-ipams --query 'Ipams[*].[IpamId,Tags]'
#   aws ec2 describe-ipam-pools --query 'IpamPools[*].[IpamPoolId,Description]'
#   aws ec2 describe-ipam-pool-cidrs --ipam-pool-id <pool-id> --query 'IpamPoolCidrs[*].IpamPoolCidrId'
#
_ipam_external_name = "ipam-0573c7815d0a36e00"

# IPv4 pool (cidrExternalName format: cidr_pool-id)
_ipv4_pool_external_name = "ipam-pool-0a82c73b97dc0dabb"
_ipv4_cidr_external_name = "10.0.0.0/8" + "_" + _ipv4_pool_external_name

# IPv6 public pool (no cidrExternalName - uses amazonProvidedIpv6CidrBlock)
_ipv6_public_pool_external_name = "ipam-pool-06b3ec78deea8bcb9"

# IPv6 private pool (ULA) - cidrExternalName format: cidr_pool-id
_ipv6_private_pool_external_name = "ipam-pool-0decd6c5216660c74"
_ipv6_private_cidr_external_name = "fdc4:f045:5323::/48" + "_" + _ipv6_private_pool_external_name 

_items = [
    metav1alpha1.E2ETest{
        metadata.name: ""
        spec = {
            crossplane.autoUpgrade.channel: "Rapid"
            defaultConditions: ["Ready"]
            manifests: [
                hops.IPAM{
                    metadata: {
                        name: _composite_name
                        namespace: "default"
                    }
                    spec: {
                        organizationName: _org_name
                        providerConfigName: "default"
                        managementPolicies: _persist
                        managementMode: "self"
                        scope: "private"
                        homeRegion: _home_region
                        operatingRegions: [_home_region]
                        if _ipam_external_name:
                            externalName: _ipam_external_name
                        pools: [
                            # IPv4 pool for VPCs
                            {
                                name: "ipv4"
                                addressFamily: "ipv4"
                                region: _home_region
                                cidr: "10.0.0.0/8"
                                managementPolicies: _persist
                                allocationDefaultNetmaskLength: 20
                                allocationMinNetmaskLength: 16
                                allocationMaxNetmaskLength: 24
                                description: "IPv4 pool for VPCs"
                                if _ipv4_pool_external_name:
                                    externalName: _ipv4_pool_external_name
                                if _ipv4_cidr_external_name:
                                    cidrExternalName: _ipv4_cidr_external_name
                                labels: {
                                    "address-family": "ipv4"
                                }
                                tags: {
                                    purpose: "vpc-ipv4"
                                }
                            },
                            # IPv6 Public Pool (Amazon-provided GUA for EKS/EC2)
                            {
                                name: "ipv6-public"
                                addressFamily: "ipv6"
                                scope: "public"
                                region: _home_region
                                locale: _home_region
                                amazonProvidedIpv6CidrBlock: True
                                publicIpSource: "amazon"
                                awsService: "ec2"
                                netmaskLength: 52  # AWS provisions /52 GUA block (16 x /56 VPC allocations)
                                managementPolicies: _persist
                                allocationDefaultNetmaskLength: 56
                                allocationMinNetmaskLength: 52
                                allocationMaxNetmaskLength: 60
                                description: "Public IPv6 pool (Amazon GUA)"
                                if _ipv6_public_pool_external_name:
                                    externalName: _ipv6_public_pool_external_name
                                labels: {
                                    "address-family": "ipv6"
                                    "ipv6-type": "public"
                                }
                                tags: {
                                    purpose: "vpc-ipv6-public"
                                }
                            },
                            # IPv6 Private Pool (ULA - AWS auto-assigns from fd00::/8)
                            {
                                name: "ipv6-private"
                                addressFamily: "ipv6"
                                scope: "private"
                                region: _home_region
                                locale: _home_region
                                netmaskLength: 48  # AWS auto-assigns ULA CIDR
                                managementPolicies: _persist
                                allocationDefaultNetmaskLength: 56
                                allocationMinNetmaskLength: 48
                                allocationMaxNetmaskLength: 64
                                description: "Private IPv6 pool (ULA)"
                                if _ipv6_private_pool_external_name:
                                    externalName: _ipv6_private_pool_external_name
                                if _ipv6_private_cidr_external_name:
                                    cidrExternalName: _ipv6_private_cidr_external_name
                                labels: {
                                    "address-family": "ipv6"
                                    "ipv6-type": "private"
                                }
                                tags: {
                                    purpose: "vpc-ipv6-private"
                                }
                            },
                            # Ephemeral test pool - deleted after test run
                            {
                                name: _test_pool_name
                                addressFamily: "ipv4"
                                region: _home_region
                                cidr: "172.31.0.0/16"
                                # Full management - gets deleted
                                managementPolicies: ["*"]
                                allocationDefaultNetmaskLength: 24
                                allocationMinNetmaskLength: 20
                                allocationMaxNetmaskLength: 28
                                description: "Ephemeral test pool - " + _test_pool_name
                                labels: {
                                    "ephemeral": "true"
                                    "test-run": _now
                                }
                                tags: {
                                    purpose: "e2e-test"
                                    "test-run": _now
                                }
                            }
                        ]
                    }
                }
            ]
            extraResources: [
                {
                    apiVersion: "v1"
                    kind: "Secret"
                    metadata: {
                        name: "aws-creds"
                        namespace: "default"
                    }
                    data: {
                        creds: _base64_creds
                    }
                },
                {
                    apiVersion: "aws.m.upbound.io/v1beta1"
                    kind: "ProviderConfig"
                    metadata: {
                        name: "default"
                        namespace: "default"
                    }
                    spec: {
                        credentials: {
                            source: "Secret"
                            secretRef: {
                                namespace: "default"
                                name: "aws-creds"
                                key: "creds"
                            }
                        }
                    }
                }
            ]
            skipDelete: True
            timeoutSeconds: 4500
        }
    }
]
items = _items
