# IPAM with IPv4 and IPv6 pools, each with automatic subnet pools
# Tests that subnetPool.enabled inherits addressFamily from parent pool
#
# Creates:
# - IPv4 VPC pool (10.0.0.0/8) with auto-generated subnet pool
# - IPv6 private ULA pool (netmaskLength: 56) with auto-generated subnet pool
# - IPv6 public GUA pool (Amazon-provided) with auto-generated subnet pool
#
# The subnet pools should inherit addressFamily from their parent:
# - ipv4-vpc-subnets: addressFamily: ipv4
# - ipv6-ula-subnets: addressFamily: ipv6
# - ipv6-gua-subnets: addressFamily: ipv6
apiVersion: aws.hops.ops.com.ai/v1alpha1
kind: IPAM
metadata:
  name: dual-stack
  namespace: infra
spec:
  scope: private
  homeRegion: us-east-1
  pools:
    # IPv4 VPC pool with automatic subnet pool
    - name: ipv4-vpc
      addressFamily: ipv4
      cidr: "10.0.0.0/8"
      allocationDefaultNetmaskLength: 16
      allocationMinNetmaskLength: 16
      allocationMaxNetmaskLength: 20
      labels:
        address-family: ipv4
      subnetPool:
        enabled: true
        allocationDefaultNetmaskLength: 24
        allocationMinNetmaskLength: 20
        allocationMaxNetmaskLength: 28
        description: "IPv4 subnet pool"

    # IPv6 private ULA pool with automatic subnet pool
    # The subnet pool should inherit addressFamily: ipv6
    - name: ipv6-ula
      addressFamily: ipv6
      scope: private
      netmaskLength: 56
      allocationDefaultNetmaskLength: 60
      allocationMinNetmaskLength: 56
      allocationMaxNetmaskLength: 64
      labels:
        address-family: ipv6
        ipv6-type: ula
      subnetPool:
        enabled: true
        allocationDefaultNetmaskLength: 64
        allocationMinNetmaskLength: 60
        allocationMaxNetmaskLength: 64
        description: "IPv6 ULA subnet pool"

    # IPv6 public GUA pool (Amazon-provided) with automatic subnet pool
    # The subnet pool should inherit addressFamily: ipv6
    - name: ipv6-gua
      addressFamily: ipv6
      scope: public
      amazonProvidedIpv6CidrBlock: true
      publicIpSource: amazon
      awsService: ec2
      netmaskLength: 52
      allocationDefaultNetmaskLength: 56
      allocationMinNetmaskLength: 52
      allocationMaxNetmaskLength: 60
      labels:
        address-family: ipv6
        ipv6-type: gua
      subnetPool:
        enabled: true
        allocationDefaultNetmaskLength: 64
        allocationMinNetmaskLength: 60
        allocationMaxNetmaskLength: 64
        description: "IPv6 GUA subnet pool"
